---
// src/pages/topics/[topic].astro
import { getCollection, type CollectionEntry } from 'astro:content';

import { Background } from '@/components/background';
import { BlogPosts } from '@/components/blocks/blog-posts';
import DefaultLayout from '@/layouts/DefaultLayout.astro';


export async function getStaticPaths() {
    const allPosts = await getCollection('blog');
    
    // ðŸš¨ Define TOPIC_OPTIONS and topicMap locally inside getStaticPaths for safety
    const TOPIC_OPTIONS = [
        { label: 'Machine Learning', value: 'machine-learning' },
        { label: 'Deep Learning', value: 'deep-learning' },
        { label: 'Data Science', value: 'data-science' },
        { label: 'Natural Language Processing', value: 'nlp' },
        { label: 'Computer Vision', value: 'computer-vision' },
        { label: 'Astro/Web Development', value: 'web-dev' },
    ];
    const topicMap = new Map(TOPIC_OPTIONS.map(t => [t.value, t.label]));


    // 1. Get ALL unique topics from ALL posts
    const allTopics = allPosts.flatMap(post => post.data.topics || []);
    const uniqueTopics = [...new Set(allTopics)];
    
    // 2. Map unique topics to dynamic paths
    return uniqueTopics.map(topicSlug => {
        // Filter: Post is included if its 'topics' array includes the current 'topicSlug'
        const posts = allPosts
            .filter(post => post.data.topics && post.data.topics.includes(topicSlug))
            .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

        // Get the human-readable label
        const topicLabel = topicMap.get(topicSlug) || topicSlug;

        return {
            params: { topic: topicSlug }, // Creates the URL slug (e.g., /topics/machine-learning)
            props: { posts, topicLabel },
        };
    });
}

// 3. Define the expected properties for the page
interface TopicProps {
    posts: CollectionEntry<'blog'>[]; 
    topicLabel: string; 
}

const { posts, topicLabel } = Astro.props as TopicProps;

const title = `Topic: ${topicLabel}`;
const description = `All blog posts related to the core topic: ${topicLabel}.`;

---

<DefaultLayout title={title} description={description}>
    <Background>
        <div class="py-28 lg:pt-44 lg:pb-32">
            <h1 class="text-5xl font-extrabold text-center mb-4">Articles on: {topicLabel}</h1>
            <p class="text-xl text-center text-gray-600 mb-12">
                Content that is categorized under **{topicLabel}**.
            </p>
            {/* Reuses your existing BlogPosts component for rendering the list */}
            <BlogPosts posts={posts} client:only='react' />
        </div>
    </Background>
</DefaultLayout>