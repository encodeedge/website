---
// src/pages/topics/index.astro
import { getCollection } from 'astro:content';

import { Background } from '@/components/background';
import { SITE_TITLE } from '@/consts';
import DefaultLayout from '@/layouts/DefaultLayout.astro';

// üö® Must match the topic options defined in keystatic.config.ts
const TOPIC_OPTIONS = [
    { label: 'Machine Learning', value: 'machine-learning' },
    { label: 'Deep Learning', value: 'deep-learning' },
    { label: 'Data Science', value: 'data-science' },
    { label: 'Natural Language Processing', value: 'nlp' },
    { label: 'Computer Vision', value: 'computer-vision' },
    { label: 'Astro/Web Development', value: 'web-dev' },
];
const topicMap = new Map(TOPIC_OPTIONS.map(t => [t.value, t.label]));

const allPosts = await getCollection('blog');

// Calculate counts for each unique topic slug
const topicCounts = allPosts.reduce((acc, post) => {
    // Iterate over the array of topics for each post
    (post.data.topics || []).forEach(topicSlug => {
        if (!acc[topicSlug]) {
            acc[topicSlug] = {
                count: 0,
                // Use the predefined label for consistent display
                label: topicMap.get(topicSlug) || topicSlug, 
                slug: topicSlug,
            };
        }
        acc[topicSlug].count++;
    });
    return acc;
}, {} as Record<string, { count: number; label: string; slug: string }>);

// Convert to an array and sort by post count (descending)
const topics = Object.values(topicCounts).sort((a, b) => b.count - a.count);

const title = `All Topics | ${SITE_TITLE}`;
const description = 'A directory of all AI and ML topics covered on this blog.';

// Helper function to assign an icon (requires a basic icon set like lucide-react or similar CSS)
const getIcon = (slug: string) => {
    switch (slug) {
        case 'machine-learning': return 'üß†';
        case 'deep-learning': return 'ü§ñ';
        case 'data-science': return 'üìä';
        case 'nlp': return 'üó£Ô∏è';
        case 'computer-vision': return 'üëÅÔ∏è';
        case 'web-dev': return 'üíª';
        default: return 'üìñ';
    }
};

---

<DefaultLayout title={title} description={description}>
    <Background>
        <div class="py-28 lg:pt-44 lg:pb-32 max-w-6xl mx-auto px-4">
            <h1 class="text-5xl font-extrabold text-center mb-4">Explore AI/ML Topics</h1>
            <p class="text-xl text-center text-gray-600 mb-12">
                Select a primary topic to view all related articles. Topics are sorted by article count.
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {topics.map(topic => (
                    <a 
                        href={`/topics/${topic.slug}`} 
                        class="group block p-6 border border-gray-200 rounded-xl shadow-lg 
                                bg-white hover:bg-gray-50 
                                hover:border-blue-500 transition-all duration-300 relative overflow-hidden"
                    >
                        {/* Subtle background element on hover */}
                        <div class="absolute inset-0 bg-blue-50 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"></div>

                        <div class="relative z-10 flex items-start gap-4">
                            <span class="text-3xl mt-1">{getIcon(topic.slug)}</span>
                            
                            <div>
                                <h2 class="text-xl font-bold text-gray-900 group-hover:text-blue-700 transition-colors">
                                    {topic.label}
                                </h2>
                                <p class="mt-1 text-sm text-gray-500">
                                    {topic.count} {topic.count === 1 ? 'article' : 'articles'}
                                </p>
                                
                                {/* Read more link visually */}
                                <div class="mt-3 text-sm font-medium text-blue-600 flex items-center">
                                    Explore Content 
                                    <svg class="w-4 h-4 ml-1 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </div>
                            </div>
                        </div>
                    </a>
                ))}
            </div>
        </div>
    </Background>
</DefaultLayout>